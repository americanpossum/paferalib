var linkstoadd=[];var existinglinks=[];var deletedlinks=[];var sortfield="";var sortorder="ASC";var currentobj=null;function DisplayFields(){var c=$$(".ModelSelect").value;var a=[];sortfield="";sortorder="ASC";for(var b in modelfields[c].fields){if(!sortfield){sortfield=b}a.push("<div class=ToggleButton data-toggled=on>"+b+"</div>")}$(".ModelFields").ht(a.join("\n"));P.MakeToggleButtons(".ModelFields .ToggleButton")}function SortBy(a){if(a==sortfield){sortorder=(sortorder=="ASC")?"DESC":"ASC"}else{sortfield=a}ListObjects()}function ListObjects(e,f,a){currentobj=null;e=e||"";f=f||0;a=a||100;if(!e&&sortfield){e=sortfield+" "+sortorder}var c=$$(".ModelSelect").value;var b=P.ToggledButtons(".ModelFields .ToggleButton").on;var d=$(".SearchResults");P.Loading(d);_db.Find("items",c,$$(".SearchFilter").value,{start:f,limit:a,orderby:e,fields:b.join(", ")}).then(function(p){var o=p.itemscount;var h=p.items;var g=[];if(h.length){g.push('<table class="TypeList Styled FullWidth"><thead><tr>');for(var m=0;m<b.length;m++){var l="";if(b[m]==sortfield){l=(sortorder=="ASC")?'<img src="'+P.baseurl+'/a/main/i/icons/up.png" class=LineHeight>':'<img src="'+P.baseurl+'/a/main/i/icons/down.png" class=LineHeight>'}g.push("<th class=Button onclick=\"SortBy('"+b[m]+"')\">"+b[m]+l+"</th>")}g.push("<th></th><th></th><th></th></tr></thead><tbody>");for(var m=0;m<h.length;m++){var n=h[m];g.push("<tr>");for(var k=0;k<b.length;k++){g.push("<td>"+n[b[k]]+"</td>")}g.addtext(['<td onclick="EditObject('+EncodeEntities($.toJSON(GetIDs(c,n)))+')" class=Color1>Edit</td>',"<td onclick=\"P.EditPermissionPopup('"+c+"', "+EncodeEntities($.toJSON(GetIDs(c,n)))+')" class=Color2>Permission</td>','<td onclick="DeleteObject('+EncodeEntities($.toJSON(GetIDs(c,n)))+')" class=Color3>Delete</td></tr>'])}g.push("</tbody></table>");g=g.concat(P.PageBar(o,f,a,e,h.length))}else{g.push("<p>No items found.</p>")}d.ht(g.join("\n"))}).error(function(g){d.ht("<div class=Error>"+g.error+"</div>")})}function EditObjectForm(g,m,j,s){var e=["<form class=ObjForm>"];var h="";deletedlinks=[];existinglinks=[];linkstoadd=[];if(P.screensize!="small"){e.push('<table class="EditObjForm">')}for(var p in m){if(m[p]=="translation"){continue}var f=g?g[p]:"";if(!f){f=""}switch(m[p]){case"multitext":h='<div class=FlexInput data-name="'+p+'" data-value="'+EncodeEntities(f.toString())+'"></div>';break;case"int":case"number":if(!f){f=0}h='<input type=number name="'+p+'" class="'+p+'" value="'+f+'">';break;case"float":if(!f){f=0}h='<input type=number step=any name="'+p+'" class="'+p+'" value="'+f+'">';break;case"datetime-local":if(!f){f=new Date().toISOString().substr(0,19)}h='<input type=datetime-local name="'+p+'" class="'+p+'" value="'+GMTToLocal(f)+'">';break;default:h="<input type="+m[p]+' name="'+p+'" class="'+p+'" value="'+EncodeEntities(f.toString())+'">'}if(P.screensize=="small"){e=e.concat(["<div>",'<label for="'+p+'">'+p+"</label>",h,"<div class=Cleared></div>","</div>"])}else{e=e.concat(["<tr>","<td>"+p+"</td>","<td>"+h+"</td>","</tr>"])}}if(P.screensize!="small"){e.push("</table>")}e=e.concat(["</form>","<div class=ButtonBar>",'<a class="Color3" onclick="SaveObject()">Save</a>','<a class="Color2" onclick="RefreshObject()">Refresh</a>','<a class="Color1" onclick="ListObjects()">Cancel</a>',"</div>","<div class=Cleared></div>","<div class=SaveResults></div>"]);if(s){if(!IsEmpty(g.LinkedAll)){e.push("<h2>Links</h2>");for(var d in g.LinkedAll){e=e.concat(["<h3>"+d+"</h3>","<table class=Styled>","<thead>","<tr>"].join("\n"));var b=g.LinkedAll[d];var n=modelfields[d].ids;for(var u in n){e.push("<th>"+u+"</th>")}e=e.concat(["<th>Link Type</th><th></th>","</tr>"].join("\n"));for(var r=0,o=b.length;r<o;r++){var t=b[r];var c={dbmodel:d,dblinktype:t.dblinktype};e.push("<tr>");for(var u in n){e.push("<td>"+t[u]+"</td>");c[u]=t[u]}e=e.concat(["<td>"+t.dblinktype+"</td>",'<td class="Color1 DeleteLink" data-model="'+EncodeEntities(d)+'" data-obj="'+EncodeEntities($.toJSON(c))+'">Delete</td>',"</tr>"].join("\n"))}e.push("</table>")}}e.addtext(["<div class=Cleared></div>","<div class=ButtonBar>","<select class=LinkModel>"]);for(var d in modelfields){e.push("<option>"+d+"</option>")}e.addtext(["</select>",'<a class="InlineButton AddLinkButton Color1">Add Link</a>',"</div>","<div class=Cleared></div>","<h2>Translations</h2>","<table class=Styled>","<thead>","<tr>","<th></th>"]);for(var p in languages){e.push("<th>"+p+"</th>")}e.push("</tr></thead><tbody>");for(var p in m){if(m[p]=="translation"){e.push("<tr><th>"+p+"</th>");for(var w in languages){var q=languages[w];var a=p+"_"+q;e.push('<td class=Translation data-varname="'+a+'">'+(g[a]?g[a]:"")+"</td>")}e.push("</tr>")}}e.push("</tbody></table>")}j.ht(e.join("\n"));P.FlexInput();$(".DeleteLink").on("click",function(){var i=$(this);var l=$.parseJSON(i.get("%obj"));var k=$$(".ModelSelect").value;_db.Unlink(k,GetIDs(k,currentobj),l.dbmodel,l);P.DeleteParent("tr",i)});$(".Translation").on("click",function(){var i=$(this);P.EditThis(i,function(v,x){var l=v.get("%varname");currentobj[l]=x;var k={};k[l]=x;_db.SaveTranslation("result",$$(".ModelSelect").value,currentobj,k)})});$(".AddLinkButton").on("click",AddLinks)}function GetLinkValues(e){var a={};if(e){var d=$("td",$(e).up(),true);for(var b=0;b<activefields.length;b++){var c=$(d[b]);a[c.get("%field")]=c.text()}}return a}function GetIDs(b,a){var d={};for(var c in modelfields[b].ids){d[c]=a[c]}return d}function EditObject(c){var a=$$(".ModelSelect").value;var b=$(".SearchResults");P.Loading(b);if(!IsEmpty(c)){_db.Load("obj",a,c,0,["LinkedAll","Tags"]).then(function(e){currentobj=e.obj;EditObjectForm(currentobj,modelfields[a].fields,b,true)}).error(function(e){b.ht("<div class=Error>"+e.error+"</div>")})}else{currentobj=null;EditObjectForm({},modelfields[a].fields,b,false)}}function RefreshObject(){EditObjectForm(currentobj,modelfields[$$(".ModelSelect").value].fields,$(".SearchResults"),true)}function SaveObject(){var a=$(".SaveResults");P.Loading(a);_db.Save("unused",$$(".ModelSelect").value,P.FormToArray(".ObjForm")).then(function(b){a.ht('<div class="GreenBackground Padded">Your changes have been saved.</div>');setTimeout(ListObjects,2000)}).error(function(b){a.ht("<div class=Error>Problem saving: "+b.error+".</div>")})}function DeleteObject(b){var a=P.Popup(HTML(['<div class="DeleteDialog yellowg Pad50">',"<p>Really delete this object?</p>","<div class=ButtonBar>",'<a class="ConfirmButton Color3">Delete</a>','<a class="CancelButton Color1" onclick="P.CloseThisPopup(this)">Don\'t Delete</a>',"</div>","</div>"].join("\n")));$(".DeleteDialog .ConfirmButton").on("click",function(){ReallyDeleteObject(b)})}function ReallyDeleteObject(d,a){var b=$$(".ModelSelect").value;var c=$(".SearchResults");P.Loading(c);_db.Delete(b,d,0).then(function(e){c.ht('<div class="GreenBackground Padded">Object deleted.</div>');setTimeout(function(){P.CloseThisPopup(".DeleteDialog");ListObjects()},1000)}).error(function(e){c.ht("<div class=Error>"+e.error+"</div>")})}function AddLinks(){if(deletedlinks.length){RefreshObject();setTimeout(AddLinks,2000);return}$(".FullScreen").set("+whiteb").ht(["<p>",'<input type=number class=LinkType placeholder="Link type">','<input type=search class=LinkSearchFilter placeholder="Unique ID contains">','<span class="Button Color2" onclick="ListAvailableLinks()">Search</span>',"</p>","<div class=AddLinksList></div>","<div class=ButtonBar>",'<a class="ConfirmButton Color3" onclick="LinkObjects()">Link Objects</a>','<a class="Spacer Width8"></a>','<a class="CancelButton Color1" onclick="$(\'.FullScreen\').hide();">Cancel</a>',"</div>"].join("\n")).show();P.Loading(".AddLinksList");ListAvailableLinks()}function ListAvailableLinks(e,h,b){var f=$$(".LinkModel").value;var c=Keys(modelfields[f].ids);existinglinks=[];linkstoadd=[];var g=currentobj.LinkedAll[f];if(!IsEmpty(g)){for(var d=0,a=g.length;d<a;d++){existinglinks.push(JSON.stringify(GetIDs(f,g[d])))}}e=e||c.join(", ");h=h||0;b=b||20;cond=$(".LinkSearchFilter").get("value");_db.Find("links",f,cond,{start:h,limit:b,orderby:e}).then(function(r){var p=r.linkscount;var l=r.links;if(!l.length){$(".AddLinksList").ht("No available links found.");return}var k=['<table class="Width100 Center">'];k.push("<tr>");for(var m=0;m<c.length;m++){k.push("<th>"+c[m]+"</th>")}k.push("</tr>");for(var n=0;n<l.length;n++){var o=l[n];var q=JSON.stringify(GetIDs(f,o));if(existinglinks.indexOf(q)==-1){k.push('<tr class=ToggleButton data-toggled=unset data-linkid="'+EncodeEntities(q)+'">');for(var m=0;m<c.length;m++){k.push("<td>"+o[c[m]]+"</td>")}k.push("</tr>")}}k.push("</table><div class=PurpleGradient>");k.addtext(P.PageBar(p,h,b,"",l.length,"ListAvailableLinks"));k.push("</div>");$(".AddLinksList").ht(k.join("\n"));P.MakeToggleButtons(".AddLinksList .ToggleButton");$(".AddLinksList .ToggleButton").on("click",function(u){var j=$(this);var t=j.get("%linkid");if(j.get("%toggled")=="on"){linkstoadd.push(t)}else{for(var s=0;s<linkstoadd.length;s++){if(linkstoadd[s]==t){linkstoadd.splice(s,1);break}}}})}).error(function(i){$(".AddLinksList").ht("<div class=Error>"+i.error+"</div>")})}function LinkObjects(){var e=[];for(var c=0;c<existinglinks.length;c++){e.push(JSON.parse(existinglinks[c]))}for(var c=0;c<linkstoadd.length;c++){e.push(JSON.parse(linkstoadd[c]))}var b=$$(".ModelSelect").value;var d=$$(".LinkModel").value;var a=parseInt($$(".LinkType").value);if(!a||isNaN(a)){a=0}$(".FullScreenContent").ht("<div class=whiteb>","<p>Now saving your links...</p>","<p class=LinkResults></p>","</div>");$(".FullScreen").show();P.Loading(".LinkResults");_db.LinkArray(b,GetIDs(b,currentobj),d,e,a,0,0).then(function(f){$(".LinkResults").fill("Links saved.");setTimeout(function(){$(".FullScreen").hide()},1000)}).error(function(f){$(".LinkResults").ht("<div class=Error>"+f.error+"</div>")})};